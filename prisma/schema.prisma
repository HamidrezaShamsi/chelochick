generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  pending
  in_kitchen
  ready_for_pickup
  completed
  cancelled
  refunded
}

model MenuCategory {
  id        String     @id @default(cuid())
  name      String
  sortOrder Int        @default(0)
  items     MenuItem[]
}

model MenuItem {
  id          String   @id @default(cuid())
  name        String
  description String?
  priceCents  Int
  isAvailable Boolean  @default(true)
  categoryId  String
  createdAt   DateTime @default(now())

  // Existing relations
  category   MenuCategory @relation(fields: [categoryId], references: [id])
  orderItems OrderItem[]

  // Add this relation
  favoriteByUsers UserFavorite[]
}

model Order {
  id            String   @id @default(cuid())
  code          String   @unique
  customerName  String
  customerPhone String
  customerEmail String?
  userId        String? // Add this field
  pickupSlot    DateTime
  subtotalCents Int
  taxCents      Int
  totalCents    Int
  status        String   @default("pending")
  createdAt     DateTime @default(now())

  user     User?       @relation(fields: [userId], references: [id])
  items    OrderItem[]
  payments Payment[]
}

model OrderItem {
  id             String   @id @default(cuid())
  orderId        String
  order          Order    @relation(fields: [orderId], references: [id])
  menuItemId     String
  name           String
  unitPriceCents Int
  quantity       Int
  notes          String?
  MenuItem       MenuItem @relation(fields: [menuItemId], references: [id])
}

model Payment {
  id              String   @id @default(cuid())
  orderId         String   @unique
  order           Order    @relation(fields: [orderId], references: [id])
  provider        String   @default("stripe")
  paymentIntentId String   @unique
  status          String
  amountCents     Int
  currency        String   @default("CAD")
  raw             Json
  createdAt       DateTime @default(now())
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  message   String
  createdAt DateTime @default(now())
}

model NewsletterSubscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  createdAt DateTime @default(now())
  source    String? // "contact" or "checkout"
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  password    String   // hashed
  name        String
  phone       String?
  createdAt   DateTime @default(now())
  
  // Relations
  orders      Order[]
  favoriteItems UserFavorite[]
}

model UserFavorite {
  id         String   @id @default(cuid())
  userId     String
  menuItemId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id])
  menuItem MenuItem @relation(fields: [menuItemId], references: [id])

  @@unique([userId, menuItemId])
}
